{
    "provider": "aws",
    "service": "opensearch",
    "checks": [
        {
            "name": "domain_does_not_use_internal_user_database",
            "title": "Ensure that Amazon Elasticsearch/Opensearch Service domains do not user the internal user database",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": ["security", "compliance"],
            "risk": "Internal User Database is convenient for demos; for production environment use Federated authentication.",
            "severity": "medium",
            "detect": {
                "resoto": "search is(aws_opensearch_domain) and advanced_security_options.internal_user_database_enabled==true"
            },
            "remediation": {
                "text": "Remove users from internal user database and uso Cognito instead.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/fgac.html"
            }
        },
        {
            "name": "domain_is_not_publicly_accessible",
            "title": "Ensure that Amazon Opensearch/Elasticsearch domains are not set as Public or have open policy access",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": ["security", "compliance"],
            "risk": "Publicly accessible services could expose sensitive data to bad actors.",
            "severity": "medium",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and access_policies.Statement[*].{Effect==\"Allow\" and (Principal.AWS=\"*\" or Principal=\"*\") and (Condition==null or Condition.IpAddress.`aws:SourceIp`[] in [\"*\", \"0.0.0.0/0\"])}"
            },
            "remediation": {
                "text": "Use  VPC endpoints for internal services.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-vpc.html"
            }
        },
        {
            "name": "domain_uses_cognito_authentication",
            "title": "Ensure that Amazon Opensearch Service domains have Amazon Cognito authentication enabled.",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": ["security", "compliance"],
            "risk": "Using Cognito authentication is more secure than using the internal user database.",
            "severity": "medium",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and cognito_options==null"
            },
            "remediation": {
                "text": "If you do not configure Amazon Cognito authentication, you can still protect Kibana using an IP-based access policy and a proxy servers, HTTP basic authentication, or SAML.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-ac.html"
            }
        },
        {
            "name": "audit_logs_enabled",
            "title": "Ensure that Amazon Opensearch Service domains have audit logs enabled.",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": ["security", "compliance"],
            "risk": "If logs are not enabled, monitoring of service use and threat analysis is not possible.",
            "severity": "low",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and log_publishing_options.AUDIT_LOGS.enabled in [null, false]"
            },
            "remediation": {
                "text": "Make sure you are logging information about Amazon Elasticsearch Service operations.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/audit-logs.html"
            }
        },
        {
            "name": "update_available",
            "title": "Ensure that Amazon Opensearch Service domains are running the latest version.",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": [],
            "risk": "Amazon Opensearch regularly releases system software updates that add features or otherwise improve your domains.",
            "severity": "low",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and service_software_options.update_available==true"
            },
            "remediation": {
                "text": "The Notifications panel in the console is the easiest way to see if an update is available or check the status of an update. You can also receive these notifications through Amazon EventBridge. If you take no action on required updates; Amazon ES still updates your domain service software automatically after a certain timeframe (typically two weeks). In this situation; Amazon ES sends notifications when it starts the update and when the update is complete.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-service-software.html"
            }
        },
        {
            "name": "encryption_at_rest_enabled",
            "title": "Ensure that Amazon Opensearch Service domains have encryption at rest enabled.",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": [],
            "risk": "Not encrypting data at rest could expose sensitive data to bad actors.",
            "severity": "low",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and encryption_at_rest_options.enabled=false"
            },
            "remediation": {
                "text": "Enable encryption at rest using AWS KMS to store and manage your encryption keys and the Advanced Encryption Standard algorithm with 256-bit keys (AES-256) to perform the encryption.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/encryption-at-rest.html"
            }
        }
    ]
}
