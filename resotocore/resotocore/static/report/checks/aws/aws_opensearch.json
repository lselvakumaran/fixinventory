{
    "provider": "aws",
    "service": "opensearch",
    "checks": [
        {
            "name": "domain_does_not_use_internal_user_database",
            "title": "Ensure that Amazon OpenSearch Service domains do not use the internal user database",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": ["security", "compliance"],
            "risk": "Using the Internal User Database for production environments is risky as it lacks the security benefits of Federated authentication.",
            "severity": "medium",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and advanced_security_options.internal_user_database_enabled==true"
            },
            "remediation": {
                "text": "To fix this issue, remove the users from the internal user database and utilize Cognito for authentication instead.",
                "url": "https://docs.aws.amazon.com/opensearch-service/latest/developerguide/fgac.html"
            },
            "url": "https://docs.aws.amazon.com/opensearch-service/latest/developerguide/fgac.html"
        },
        {
            "name": "domain_is_not_publicly_accessible",
            "title": "Ensure that Amazon OpenSearch/Elasticsearch domains are not publicly accessible or have open policy access",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": ["security", "compliance"],
            "risk": "Failure to address this issue may result in exposing sensitive data to unauthorized individuals or malicious actors.",
            "severity": "medium",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and access_policies.Statement[*].{Effect==\"Allow\" and (Principal.AWS=\"*\" or Principal=\"*\") and (Condition==null or Condition.IpAddress.`aws:SourceIp`[] in [\"*\", \"0.0.0.0/0\"])}"
            },
            "remediation": {
                "text": "To resolve this issue, ensure that Amazon OpenSearch/Elasticsearch domains are not set as Public and restrict access through VPC endpoints.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-vpc.html"
            },
            "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-vpc.html"
        },
        {
            "name": "domain_uses_cognito_authentication",
            "title": "Ensure that Amazon OpenSearch Service domains have Amazon Cognito authentication enabled.",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": ["security", "compliance"],
            "risk": "Not using Amazon Cognito authentication leaves the domain vulnerable to unauthorized access and compromises the security of the OpenSearch Service.",
            "severity": "medium",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and cognito_options==null"
            },
            "remediation": {
                "text": "To address this issue, configure Amazon Cognito authentication. This helps protect the domain by providing secure user authentication and access control.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-cognito-auth.html"
            },
            "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-cognito-auth.html"
        },
        {
            "name": "audit_logs_enabled",
            "title": "Ensure that Amazon OpenSearch Service domains have audit logs enabled",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": ["security", "compliance"],
            "risk": "If audit logs are not enabled, monitoring of service use and threat analysis is not possible.",
            "severity": "low",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and log_publishing_options.AUDIT_LOGS.enabled in [null, false]"
            },
            "remediation": {
                "text": "Ensure that you enable logging information about Amazon OpenSearch Service operations.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/audit-logs.html"
            },
            "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/audit-logs.html"
        },
        {
            "name": "update_available",
            "title": "Ensure that Amazon OpenSearch Service domains are running the latest version.",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": [],
            "risk": "Failure to update Amazon Opensearch Service domains to the latest version can leave them vulnerable to security risks and prevent them from benefiting from new features and improvements.",
            "severity": "low",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and service_software_options.update_available==true"
            },
            "remediation": {
                "text": "To ensure that your Amazon OpenSearch Service domains are running the latest version, regularly check the Notifications panel in the console for available updates. You can also receive notifications through Amazon EventBridge. It is recommended to apply the updates promptly to maintain the security and functionality of your domains.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-service-software.html"
            },
            "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-service-software.html"
        },
        {
            "name": "encryption_at_rest_enabled",
            "title": "Ensure that encryption at rest is enabled for Amazon OpenSearch Service domains",
            "result_kinds": ["aws_opensearch_domain"],
            "categories": [],
            "risk": "Encrypting data at rest is critical to protect sensitive data from unauthorized access.",
            "severity": "low",
            "detect": {
                "resoto": "is(aws_opensearch_domain) and encryption_at_rest_options.enabled=false"
            },
            "remediation": {
                "text": "To fix this issue, enable encryption at rest for your Amazon OpenSearch Service domain using AWS KMS to store and manage your encryption keys and the Advanced Encryption Standard algorithm with 256-bit keys (AES-256) for encryption.",
                "url": "https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/encryption-at-rest.html"
            }
        }
    ]
}
