{
    "provider": "aws",
    "service": "lambda",
    "checks": [
        {
            "name": "publicly_accessible_permissions",
            "title": "Check if Lambda functions have resource-based policy set as Public.",
            "result_kinds": ["aws_lambda_function"],
            "categories": [
                "security",
                "compliance"
            ],
            "risk": "Publicly accessible services could expose sensitive data to bad actors.",
            "severity": "low",
            "url": "https://docs.aws.amazon.com/lambda/latest/dg/logging-using-cloudtrail.html",
            "detect": {
                "resoto": "is(aws_lambda_function) and function_policy.statement[*].{principal~\"*\" or principal.AWS~\"*\" or principal.CanonicalUser~\"*\"}"
            },
            "remediation": {
                "text": "Grant usage permission on a per-resource basis and applying least privilege principle.",
                "url": "https://docs.aws.amazon.com/lambda/latest/dg/access-control-resource-based.html"
            }
        },
        {
            "name": "function_in_vpc",
            "title": "Ensure that Lambda functions are deployed within a VPC employ security groups for precise access control and adhere to compliance standards, providing isolated and controlled network access.",
            "result_kinds": ["aws_lambda_function"],
            "categories": [ "security", "compliance" ],
            "risk": "Publicly accessible Lambda functions without precise access controls through security groups pose a risk to security",
            "severity": "medium",
            "detect": {
                "resoto": "is(aws_lambda_function) with (empty, <-- is(aws_vpc))"
            },
            "remediation": {
                "text": "Change the lambda function configuration to deploy lambda function in VPC",
                "url": "https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html"
            }
        },
        {
            "name": "cors_policy",
            "title": "Check Lambda Function URL CORS configuration.",
            "result_kinds": ["aws_lambda_function"],
            "categories": [
                "security",
                "compliance"
            ],
            "risk": "Publicly accessible services could expose sensitive data to bad actors.",
            "severity": "medium",
            "url": "https://docs.aws.amazon.com/secretsmanager/latest/userguide/lambda-functions.html",
            "detect": {
                "resoto": "is(aws_lambda_function) and function_url_config.cors.allow_origins ~ \"*\""
            },
            "remediation": {
                "action": {
                    "awscli": "aws lambda update-function-url-config --region AWS_REGION --function-name FUNCTION-NAME --auth-type AWS_IAM --cors 'AllowOrigins=https://www.example.com,AllowMethods=*,ExposeHeaders=keep-alive,MaxAge=3600,AllowCredentials=false'"
                },
                "text": "Grant usage permission on a per-resource basis and applying least privilege principle.",
                "url": "https://docs.aws.amazon.com/secretsmanager/latest/userguide/lambda-functions.html"
            }
        },
        {
            "name": "function_restrict_public_access",
            "title": "Check Public Lambda Function URL.",
            "result_kinds": ["aws_lambda_function"],
            "categories": [
                "security",
                "compliance"
            ],
            "risk": "Publicly accessible services could expose sensitive data to bad actors.",
            "severity": "high",
            "url": "https://docs.aws.amazon.com/secretsmanager/latest/userguide/lambda-functions.html",
            "detect": {
                "resoto": "is(aws_lambda_function) and function_url_config.auth_type != AWS_IAM"
            },
            "remediation": {
                "action": {
                    "awscli": "aws lambda update-function-url-config --region AWS_REGION --function-name FUNCTION-NAME --auth-type AWS_IAM"
                },
                "text": "Grant usage permission on a per-resource basis and applying least privilege principle.",
                "url": "https://docs.aws.amazon.com/secretsmanager/latest/userguide/lambda-functions.html"
            }
        },
        {
            "name": "supported_runtime",
            "title": "Check that Lambda does not use an obsolete runtime.",
            "result_kinds": ["aws_lambda_function"],
            "categories": [
                "security",
                "compliance"
            ],
            "risk": "If you have functions running on a runtime that will be deprecated in the next 60 days; Lambda notifies you by email that you should prepare by migrating your function to a supported runtime. In some cases; such as security issues that require a backwards-incompatible update; or software that does not support a long-term support (LTS) schedule; advance notice might not be possible. After a runtime is deprecated; Lambda might retire it completely at any time by disabling invocation. Deprecated runtimes are not eligible for security updates or technical support.",
            "severity": "medium",
            "url": "https://docs.aws.amazon.com/lambda/latest/dg/runtime-support-policy.html",
            "detect": {
                "resoto": "is(aws_lambda_function) and function_runtime in [python3.6, python2.7, dotnetcore2.1, ruby2.5, nodejs10.x, nodejs8.10, nodejs4.3, nodejs6.10, dotnetcore1.0, dotnetcore2.0, nodejs4.3-edge, nodejs]"
            },
            "remediation": {
                "text": "Test new runtimes as they are made available. Implement them in production as soon as possible.",
                "url": "https://docs.aws.amazon.com/lambda/latest/dg/runtime-support-policy.html"
            }
        },
        {
            "name": "no_secrets_in_variables",
            "title": "Ensure that there are no secrets in AWS lambda variables..",
            "result_kinds": ["aws_lambda_function"],
            "categories": [
                "security"
            ],
            "risk": "The use of a hard-coded password increases the possibility of password guessing. If hard-coded passwords are used; it is possible that malicious users gain access through the account in question.",
            "severity": "critical",
            "url": "https://docs.aws.amazon.com/lambda/latest/dg/runtime-support-policy.html",
            "detect": {
                "resoto_cmd": "search is(aws_lambda_function) and function_environment.variables not in [null, {}] | detect-secrets --path function_environment.variables --with-secrets"
            },
            "remediation": {
                "text": "Use Secrets Manager to securely provide database credentials to Lambda functions and secure the databases as well as use the credentials to connect and query them without hardcoding the secrets in code or passing them through environmental variables.",
                "url": "https://docs.aws.amazon.com/secretsmanager/latest/userguide/lambda-functions.html"
            }
        }
    ]
}
